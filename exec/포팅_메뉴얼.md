# SSUKSSUK 포팅 메뉴얼

## 목차

1. [프로젝트 개요](#1-프로젝트-개요)
2. [개발 환경 및 버전 정보](#2-개발-환경-및-버전-정보)
3. [소스 클론 및 빌드](#3-소스-클론-및-빌드)
4. [환경변수 설정](#4-환경변수-설정)
5. [배포 방법](#5-배포-방법)
6. [배포 시 특이사항](#6-배포-시-특이사항)
7. [주요 계정 및 프로퍼티 파일 목록](#7-주요-계정-및-프로퍼티-파일-목록)
8. [DB 정보](#8-db-정보)

---

## 1. 프로젝트 개요

**SSUKSSUK**은 IoT 기반 스마트 식물 재배 모니터링 시스템입니다.

| 구성 요소 | 기술 스택 | 설명 |
|-----------|-----------|------|
| Backend | Spring Boot | REST API 서버 |
| Frontend | React Native | Android APK 모바일 앱 |
| Edge Module | Python (Jetson Nano) | 센서 데이터 수집 및 카메라 촬영 |
| Embedded | C (STM32) | 하드웨어 센서/액추에이터 제어 |
| Infra | Docker Compose | 컨테이너 오케스트레이션 |

---

## 2. 개발 환경 및 버전 정보

### 2.1 Backend (Spring Boot)

| 항목 | 버전/상세 |
|------|-----------|
| JDK | Eclipse Temurin 17 (JRE: 17-alpine) |
| Spring Boot | 3.5.7 |
| Gradle | 8.5 |
| WAS | Spring Boot 내장 Tomcat (port 8080) |
| 언어 | Java 17 |

### 2.2 Frontend (React Native → Android APK)

| 항목 | 버전/상세 |
|------|-----------|
| React Native | 0.83.1 |
| React | 19.2.0 |
| Node.js | >= 20 |
| TypeScript | 5.8.3 |
| JS Engine | Hermes |
| Android SDK | compileSdk 36, targetSdk 36, minSdk 24 (Android 7.0+) |
| Android Build Tools | 36.0.0 |
| NDK | 27.1.12297006 |
| Kotlin | 2.1.20 |
| Architecture | New Architecture 활성화 (Fabric + TurboModules) |

### 2.3 인프라

| 항목 | 버전/상세 |
|------|-----------|
| Docker Compose | 3.8 |
| Nginx | 1.25-alpine (리버스 프록시) |
| MySQL | 8.0 |
| Redis | 7-alpine |
| Eclipse Mosquitto | 2 (MQTT Broker) |
| Jenkins | LTS JDK17 (CI/CD) |
| Certbot | latest (SSL 인증서) |
| 서버 OS | Ubuntu (EC2) |

### 2.4 Edge Module (Jetson Nano)

| 항목 | 버전/상세 |
|------|-----------|
| Python | 3.8+ |
| paho-mqtt | latest |
| pyserial | latest |

---

## 3. 소스 클론 및 빌드

### 3.1 소스 클론

```bash
git clone https://lab.ssafy.com/s14-webmobile3-sub1/S14P11A103.git
cd S14P11A103
```

### 3.2 Backend 빌드

#### Docker를 이용한 빌드 (권장)

별도의 JDK 설치 없이 Docker 멀티스테이지 빌드로 처리됩니다.

```bash
# 프로젝트 루트에서
docker-compose build backend
```

Dockerfile 빌드 과정:
1. **Stage 1 (Build)**: `gradle:8.5-jdk17` 이미지에서 `gradle bootJar` 실행
2. **Stage 2 (Runtime)**: `eclipse-temurin:17-jre-alpine` 이미지에 JAR 복사

#### 로컬 빌드 (개발용)

```bash
cd server
./gradlew clean bootJar --no-daemon
# 빌드 결과: server/build/libs/*.jar
```

실행:
```bash
java -jar build/libs/ssukssuk-0.0.1-SNAPSHOT.jar
```

### 3.3 Frontend 빌드 (Android APK)

#### 사전 요구사항
- Node.js >= 20
- Android SDK (Android Studio 설치 권장)
- JDK 17

#### 빌드 순서

```bash
cd frontend/ssukssuk

# 1. 의존성 설치
npm install

# 2. Debug APK 빌드
npx react-native run-android

# 3. Release APK 빌드
cd android
./gradlew assembleRelease
# 결과물: android/app/build/outputs/apk/release/app-release.apk
```

> **참고**: Release 빌드 시 현재 debug keystore를 사용하고 있습니다. 프로덕션 배포 시에는 별도 keystore 생성이 필요합니다.

#### APK 설치

빌드된 APK 파일을 Android 기기에 직접 설치합니다:
```bash
adb install app-release.apk
```

### 3.4 Edge Module (Jetson Nano)

```bash
cd EM/jetson_app

# 의존성 설치
pip install -r requirements.txt

# 실행
python main.py
```

---

## 4. 환경변수 설정

### 4.1 서버 환경변수 (.env 파일)

프로젝트 루트에 `.env` 파일을 생성합니다. `.env.example`을 참고하세요.

```bash
cp .env.example .env
```

| 환경변수 | 설명 | 예시 |
|----------|------|------|
| `DOMAIN` | 서비스 도메인 | `i14a103.p.ssafy.io` |
| `CERTBOT_EMAIL` | SSL 인증서 이메일 | `your-email@ssafy.com` |
| `MYSQL_ROOT_PASSWORD` | MySQL root 비밀번호 | (비공개) |
| `MYSQL_DATABASE` | MySQL 데이터베이스명 | `plantcare` |
| `MYSQL_USER` | MySQL 사용자 | `plantcare_user` |
| `MYSQL_PASSWORD` | MySQL 사용자 비밀번호 | (비공개) |
| `MQTT_BROKER_HOST` | MQTT 브로커 호스트 | `mosquitto` |
| `MQTT_BROKER_PORT` | MQTT 브로커 포트 | `1883` |
| `SPRING_PROFILES_ACTIVE` | Spring 프로파일 | `prod` |
| `AWS_ACCESS_KEY_ID` | AWS S3 Access Key | (비공개) |
| `AWS_SECRET_ACCESS_KEY` | AWS S3 Secret Key | (비공개) |
| `AWS_REGION` | AWS 리전 | `ap-northeast-2` |

### 4.2 Backend Docker 환경변수

`docker-compose.yml`의 backend 서비스에서 주입되는 환경변수:

| 환경변수 | 값 |
|----------|----|
| `FIREBASE_CREDENTIALS_PATH` | `/app/firebase-service-account.json` |
| `SPRING_PROFILES_ACTIVE` | `prod` |
| `SPRING_DATASOURCE_URL` | `jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useUnicode=true` |
| `SPRING_DATASOURCE_USERNAME` | `${MYSQL_USER}` |
| `SPRING_DATASOURCE_PASSWORD` | `${MYSQL_PASSWORD}` |
| `SPRING_DATA_REDIS_HOST` | `redis` |
| `SPRING_DATA_REDIS_PORT` | `6379` |
| `mqtt.broker-uri` | `tcp://mosquitto:1883` |
| `TZ` | `Asia/Seoul` |
| `AWS_ACCESS_KEY_ID` | `.env` 파일에서 주입 |
| `AWS_SECRET_ACCESS_KEY` | `.env` 파일에서 주입 |

### 4.3 Backend application.properties 주요 설정

| 설정 | 값 | 설명 |
|------|----|------|
| `jwt.secret` | 64자 이상 시크릿 키 | JWT 토큰 서명 키 |
| `jwt.access-token-expiration-ms` | `900000` | Access Token 만료 (15분) |
| `jwt.refresh-token-expiration-ms` | `1209600000` | Refresh Token 만료 (14일) |
| `aws.s3.bucket` | `plant-images-prod-a103` | S3 버킷명 |
| `aws.s3.presign-expiration-sec` | `900` | Presigned URL 만료 (15분) |
| `spring.jpa.hibernate.ddl-auto` | `update` | JPA DDL 자동 업데이트 |

### 4.4 Firebase 설정

- 서버: Firebase 서비스 계정 JSON 파일을 호스트의 `/home/ubuntu/secrets/firebase-service-account.json`에 배치
- 프론트엔드: `frontend/ssukssuk/android/app/google-services.json` 파일 필요 (Firebase 콘솔에서 다운로드)

---

## 5. 배포 방법

### 5.1 Docker Compose를 이용한 전체 배포

```bash
# 1. 프로젝트 루트로 이동
cd /home/ubuntu/S14P11A103

# 2. .env 파일 설정 (최초 1회)
cp .env.example .env
vi .env  # 실제 값 입력

# 3. Firebase 서비스 계정 파일 배치
mkdir -p /home/ubuntu/secrets
# firebase-service-account.json 파일을 /home/ubuntu/secrets/ 에 복사

# 4. SSL 인증서 발급 (최초 1회)
# Nginx가 먼저 HTTP로 기동된 상태에서 Certbot으로 발급
docker-compose up -d nginx
docker-compose run --rm certbot certonly --webroot -w /var/www/certbot -d i14a103.p.ssafy.io

# 5. 전체 서비스 기동
docker-compose up -d

# 6. 상태 확인
docker-compose ps
```

### 5.2 서비스 구성도

```
                    ┌─────────────┐
  Client ──HTTPS──> │   Nginx     │ :443
                    │  (1.25)     │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
      /api/ │       /jenkins/      /mqtt  │
            ▼              ▼              ▼
     ┌────────────┐ ┌──────────┐ ┌──────────────┐
     │  Backend   │ │ Jenkins  │ │  Mosquitto   │
     │ (Boot:8080)│ │ (:8080)  │ │ (WS:9001)    │
     └──────┬─────┘ └──────────┘ └──────────────┘
            │                           │
     ┌──────┼──────┐              TCP:1883
     │      │      │                    │
     ▼      ▼      ▼              ┌─────┴──────┐
  ┌─────┐┌─────┐┌─────┐          │  Backend    │
  │MySQL││Redis││ S3  │          │ (MQTT Sub)  │
  │:3306││:6379││(AWS)│          └─────────────┘
  └─────┘└─────┘└─────┘
```

### 5.3 CI/CD 파이프라인

Jenkins를 통한 자동 배포가 구성되어 있습니다:

- **Jenkinsfile.ci**: GitLab MR(Merge Request) 시 BE/FE 변경 감지 후 자동 빌드/테스트
- **Jenkinsfile.cd**: master 브랜치 push 시 server/ 변경 감지 후 자동 배포
  - 기존 이미지 백업 (`:previous` 태그)
  - 새 이미지 빌드 및 컨테이너 교체
  - Health Check 실패 시 자동 롤백

### 5.4 Frontend 배포 (APK)

React Native 앱은 APK 파일로 빌드하여 Android 기기에 직접 설치합니다:

```bash
cd frontend/ssukssuk/android
./gradlew assembleRelease
```

빌드된 APK를 기기에 설치하거나 배포합니다.

---

## 6. 배포 시 특이사항

### 6.1 SSL 인증서
- Let's Encrypt를 사용하며, Certbot 컨테이너가 12시간마다 자동 갱신합니다.
- 최초 배포 시 인증서 발급이 선행되어야 Nginx HTTPS 설정이 동작합니다.

### 6.2 MQTT 통신
- 내부 서비스 간: TCP `mosquitto:1883`
- 외부 디바이스(Jetson): WebSocket `wss://i14a103.p.ssafy.io/mqtt` (Nginx 프록시, 포트 443)
- Mosquitto는 현재 Anonymous 접속을 허용하고 있습니다.

### 6.3 데이터베이스 DDL
- `spring.jpa.hibernate.ddl-auto=update` 설정으로 애플리케이션 시작 시 자동으로 테이블 생성/변경됩니다.
- 별도의 마이그레이션 스크립트 없이 JPA 엔티티 기반으로 스키마가 관리됩니다.

### 6.4 Firebase 설정
- 서버: Firebase 서비스 계정 JSON 파일이 `/home/ubuntu/secrets/firebase-service-account.json` 경로에 있어야 합니다.
- 프론트엔드: `google-services.json`이 `android/app/` 디렉토리에 있어야 합니다.

### 6.5 AWS S3
- S3 버킷(`plant-images-prod-a103`)은 사전에 생성되어 있어야 합니다.
- IAM 사용자의 Access Key / Secret Key가 `.env`에 설정되어야 합니다.
- 리전: `ap-northeast-2` (서울)

### 6.6 Jenkins
- Docker Socket 방식으로 호스트 Docker를 제어합니다.
- GitLab Webhook → Jenkins Generic Webhook Trigger 플러그인 연동.
- Jenkins 접속: `https://i14a103.p.ssafy.io/jenkins/`

### 6.7 Timezone
- 모든 서비스에 `TZ=Asia/Seoul` 설정이 적용됩니다.

---

## 7. 주요 계정 및 프로퍼티 파일 목록

### 7.1 프로퍼티/설정 파일

| 파일 경로 | 설명 |
|-----------|------|
| `/.env` | 전체 환경변수 (DB, AWS, MQTT 등) |
| `/.env.example` | 환경변수 템플릿 |
| `/server/src/main/resources/application.properties` | Spring Boot 메인 설정 (DB, JWT, MQTT, S3) |
| `/server/src/main/resources/application-dev.properties` | 개발 프로파일 설정 |
| `/server/build.gradle` | Backend 의존성 및 빌드 설정 |
| `/server/Dockerfile` | Backend Docker 이미지 빌드 |
| `/docker-compose.yml` | 전체 서비스 오케스트레이션 |
| `/infra/nginx/conf.d/10-backend.conf` | Nginx 리버스 프록시 설정 |
| `/infra/mosquitto/config/mosquitto.conf` | MQTT 브로커 설정 |
| `/frontend/ssukssuk/package.json` | Frontend 의존성 |
| `/frontend/ssukssuk/android/app/google-services.json` | Firebase Android 설정 |
| `/frontend/ssukssuk/android/gradle.properties` | Android 빌드 설정 |
| `/frontend/ssukssuk/android/app/build.gradle` | Android 앱 빌드 설정 |
| `/EM/jetson_app/config.json` | Jetson 디바이스 설정 (MQTT, UART, 카메라) |
| `/EM/jetson_app/setting.json` | Jetson 런타임 상태 파일 |
| `/Jenkinsfile.ci` | CI 파이프라인 (MR 검증) |
| `/Jenkinsfile.cd` | CD 파이프라인 (자동 배포) |

### 7.2 시크릿/인증 파일 (Git 미포함)

| 파일 | 설명 | 위치 |
|------|------|------|
| `.env` | 환경변수 (DB 비밀번호, AWS 키 등) | 프로젝트 루트 |
| `firebase-service-account.json` | Firebase Admin SDK 서비스 계정 | `/home/ubuntu/secrets/` |
| SSL 인증서 | Let's Encrypt 인증서 | `/etc/letsencrypt/live/i14a103.p.ssafy.io/` |

---

## 8. DB 정보

### 8.1 접속 정보

| 항목 | 값 |
|------|----|
| DBMS | MySQL 8.0 |
| Host (Docker 내부) | `mysql` |
| Host (외부 접속) | `i14a103.p.ssafy.io` (포트 포워딩 필요) |
| Port | 3306 |
| Database | `ssukssuk` |
| User | `root` |
| Password | `.env` 파일의 `MYSQL_ROOT_PASSWORD` 참조 |
| Character Set | utf8mb4 |
| Collation | utf8mb4_unicode_ci |
| Timezone | Asia/Seoul |

### 8.2 JDBC URL

```
jdbc:mysql://mysql:3306/ssukssuk?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useUnicode=true
```

### 8.3 DB 덤프 생성 방법

```bash
# Docker 컨테이너에서 덤프
docker exec mysql mysqldump -u root -p${MYSQL_ROOT_PASSWORD} --single-transaction --routines --triggers --set-gtid-purged=OFF ssukssuk > exec/ssukssuk_dump.sql
```

### 8.4 DB 덤프 복원 방법

```bash
# Docker 컨테이너로 복원
docker exec -i mysql mysql -u root -p${MYSQL_ROOT_PASSWORD} ssukssuk < exec/ssukssuk_dump.sql
```

> **참고**: DB 덤프 최신본은 `exec/ssukssuk_dump.sql` 파일을 참조하세요.
