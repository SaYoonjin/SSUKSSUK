# 외부 서비스 정보

SSUKSSUK 프로젝트에서 사용하는 외부 서비스 가입 및 활용 정보를 정리한 문서입니다.

---

## 1. AWS S3 (Amazon Simple Storage Service)

### 용도
- 식물 이미지 저장 (상단 카메라, 측면 카메라 촬영 이미지)
- Presigned URL을 통한 이미지 업로드/다운로드

### 가입 및 설정

1. [AWS 콘솔](https://aws.amazon.com/ko/) 접속 후 계정 생성
2. IAM 사용자 생성:
   - AWS 콘솔 → IAM → 사용자 → 사용자 생성
   - 프로그래밍 방식 액세스 활성화
   - `AmazonS3FullAccess` 정책 연결 (또는 특정 버킷 권한만 부여)
   - Access Key ID / Secret Access Key 발급
3. S3 버킷 생성:
   - 버킷 이름: `plant-images-prod-a103`
   - 리전: `ap-northeast-2` (아시아 태평양 - 서울)
   - 퍼블릭 액세스 차단 (Presigned URL로 접근)

### 프로젝트 설정

| 설정 항목 | 위치 | 값 |
|-----------|------|-----|
| `AWS_ACCESS_KEY_ID` | `.env` | IAM 사용자 Access Key |
| `AWS_SECRET_ACCESS_KEY` | `.env` | IAM 사용자 Secret Key |
| `AWS_REGION` | `.env` | `ap-northeast-2` |
| `aws.s3.bucket` | `application.properties` | `plant-images-prod-a103` |
| `aws.s3.presign-expiration-sec` | `application.properties` | `900` (15분) |

### 사용 SDK
- AWS SDK for Java v2 (`software.amazon.awssdk:s3:2.41.16`)

---

## 2. Firebase Cloud Messaging (FCM)

### 용도
- 모바일 앱 푸시 알림 (식물 상태 이상, 센서 이벤트 등)

### 가입 및 설정

1. [Firebase 콘솔](https://console.firebase.google.com/) 접속
2. 프로젝트 생성 (프로젝트명: `ssukssuk`)
3. **Android 앱 등록**:
   - 패키지명: `com.ssukssuk`
   - `google-services.json` 다운로드
   - 파일 위치: `frontend/ssukssuk/android/app/google-services.json`
4. **서비스 계정 키 발급** (Backend용):
   - Firebase 콘솔 → 프로젝트 설정 → 서비스 계정 → 새 비공개 키 생성
   - JSON 파일 다운로드
   - 서버 배치 위치: `/home/ubuntu/secrets/firebase-service-account.json`

### 프로젝트 설정

**Backend (Spring Boot)**:

| 설정 항목 | 위치 | 값 |
|-----------|------|-----|
| `FIREBASE_CREDENTIALS_PATH` | `docker-compose.yml` 환경변수 | `/app/firebase-service-account.json` |
| 파일 마운트 | `docker-compose.yml` volumes | `/home/ubuntu/secrets/firebase-service-account.json:/app/firebase-service-account.json:ro` |

**Frontend (React Native)**:

| 라이브러리 | 버전 |
|-----------|------|
| `@react-native-firebase/app` | 23.8.4 |
| `@react-native-firebase/messaging` | 23.8.4 |

**Android 설정**:
- `google-services` 플러그인 적용: `android/build.gradle` → `classpath("com.google.gms:google-services:4.4.2")`
- `android/app/build.gradle` → `apply plugin: "com.google.gms.google-services"`
- `AndroidManifest.xml` → `<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>`

### 사용 SDK
- 서버: Firebase Admin SDK for Java (`com.google.firebase:firebase-admin:9.3.0`)
- 클라이언트: React Native Firebase

---

## 3. Eclipse Mosquitto (MQTT Broker)

### 용도
- IoT 디바이스(Jetson Nano)와 백엔드 서버 간 실시간 메시지 통신
- 센서 데이터 텔레메트리, 디바이스 제어 명령 전달

### 설정 (자체 호스팅)

Mosquitto는 Docker 컨테이너로 자체 호스팅합니다. 별도 외부 서비스 가입이 필요 없습니다.

| 항목 | 값 |
|------|----|
| 이미지 | `eclipse-mosquitto:2` |
| TCP 포트 (내부) | 1883 |
| WebSocket 포트 (외부) | 9001 (Nginx → wss://domain/mqtt) |
| 인증 | Anonymous 허용 (allow_anonymous true) |
| Persistence | 활성화 (`/mosquitto/data/`) |

### MQTT 토픽 구조

```
devices/{serial_num}/telemetry/sensors          # 센서 데이터 상향
devices/{serial_num}/telemetry/action-result     # 액션 결과 상향
devices/{serial_num}/telemetry/upload-url-request # 이미지 업로드 URL 요청
devices/{serial_num}/telemetry/image-uploaded    # 이미지 업로드 완료 알림
devices/{serial_num}/telemetry/image-inference   # 이미지 추론 결과
devices/{serial_num}/telemetry/ack              # 텔레메트리 ACK

devices/{serial_num}/control/claim              # 디바이스 등록/해제
devices/{serial_num}/control/binding            # 식물 바인딩
devices/{serial_num}/control/mode               # AUTO/MANUAL 모드 전환
devices/{serial_num}/control/upload-url         # Presigned URL 전달
devices/{serial_num}/control/ack               # 제어 ACK
```

### 사용 라이브러리

| 컴포넌트 | 라이브러리 | 버전 |
|----------|-----------|------|
| Backend | Spring Integration MQTT | Spring Boot 관리 |
| Backend | Eclipse Paho MQTT v3 | 1.2.5 |
| Jetson | paho-mqtt (Python) | latest |

---

## 4. Let's Encrypt (SSL 인증서)

### 용도
- HTTPS 통신을 위한 무료 SSL/TLS 인증서 발급 및 자동 갱신

### 설정

| 항목 | 값 |
|------|----|
| 도메인 | `i14a103.p.ssafy.io` |
| 발급 방식 | Certbot (webroot) |
| 인증서 경로 | `/etc/letsencrypt/live/i14a103.p.ssafy.io/` |
| 자동 갱신 | Certbot 컨테이너에서 12시간 간격 실행 |
| SSL 프로토콜 | TLSv1.2, TLSv1.3 |

### 최초 발급

```bash
docker-compose up -d nginx
docker-compose run --rm certbot certonly \
  --webroot -w /var/www/certbot \
  -d i14a103.p.ssafy.io \
  --email your-email@ssafy.com \
  --agree-tos
```

---

## 5. GitLab (소스 관리 및 CI/CD 연동)

### 용도
- 소스코드 버전 관리
- Jenkins Webhook 연동을 통한 CI/CD 트리거

### 설정

| 항목 | 값 |
|------|----|
| 저장소 URL | `https://lab.ssafy.com/s14-webmobile3-sub1/S14P11A103.git` |
| 기본 브랜치 | `master` |
| Jenkins Credential ID | `gitlab-token` (Username/Password 형태) |
| Webhook | MR 이벤트 → Jenkinsfile.ci, Push 이벤트 → Jenkinsfile.cd |

---

## 6. 외부 서비스 요약

| 서비스 | 용도 | 가입 필요 | 비용 |
|--------|------|----------|------|
| AWS S3 | 이미지 저장소 | O | 사용량 기반 과금 |
| Firebase (FCM) | 푸시 알림 | O | 무료 (일일 한도 내) |
| Let's Encrypt | SSL 인증서 | X (자동) | 무료 |
| Eclipse Mosquitto | MQTT 브로커 | X (자체 호스팅) | 무료 (오픈소스) |
| GitLab (SSAFY) | 소스 관리 | O (SSAFY 제공) | 무료 |
